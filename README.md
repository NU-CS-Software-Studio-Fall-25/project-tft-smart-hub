# TFT Smart Hub
# Temporary Link: <https://tft-smartcomp-b3f1e37435eb.herokuapp.com/>

## ðŸ“Œ Quick Links

- ðŸ“‹ **[TODO & Roadmap](./TODO.md)** - Next sprint items and future improvements
- ðŸ›¡ï¸ **[Branch Protection Guide](./BRANCH_PROTECTION_GUIDE.md)** - How to set up branch protection
- âš™ï¸ **[CI/CD Setup](./CI_CD_SETUP.md)** - Complete CI/CD configuration
- ðŸš€ **[Quick Start Guide](./CI_CD_QUICK_START.md)** - Getting started with CI/CD

---
Milestone4:
1. RSpec Test: [View Test Summary](./docs/RSpec_TST_SUMMARY.md)
2. RDoc documentation: [View API Docs](./ruby_backend/tft_team_builder/doc/)

Useful Scripts:
Run all RSpec tests: `./run-rspec.sh`  
Run specific RSpec test: `./spec/models/user_spec.rb`  
Generate RSpec coverage report: `./run-rspec.sh coverage`  
Generate RDoc doc: `./generate-docs.sh`

Start the server locally: `./start-dev.sh`  
Stop the server locally: `./stop-dev.sh`  

---
Milestone3: 
- Cucumber tests: [View Test Summary](./ruby_backend/tft_team_builder/features/TEST_SUMMARY.md)
- Summary of features: [View Features Summary](./FEATURES.md)

## Development Cache Issues

If you experience caching issues during development where browser shows old content after code changes:

### Quick Solutions

1. **Hard Refresh**: Press `Ctrl+Shift+R` (Linux/Windows) or `Cmd+Shift+R` (Mac) to do a hard refresh
2. **Clear Browser Cache**: Open DevTools (F12) â†’ Network tab â†’ check "Disable cache"
3. **Console Command**: Open browser console and run `clearTFTCache()` to clear app cache and reload
4. **Incognito Mode**: Use incognito/private browsing mode for development

### Complete Cache Clearing

For a complete cache reset, run the cache clearing script:

```bash
./clear-cache.sh
```

This script will:
- Stop all development servers
- Clear Rails cache and temp files
- Clear Vite development cache
- Clear npm cache
- Reinstall frontend dependencies
- Clear system temp files

### Automatic Cache Busting

The app includes automatic cache busting in development mode:
- Vite server headers prevent aggressive caching
- Version checking clears old cached data
- Local storage is automatically managed

### Manual Cache Clearing

If issues persist, you can manually clear the cache by:
1. Opening browser DevTools (F12)
2. Going to Console tab
3. Running: `clearTFTCache()`
4. The page will automatically reload with fresh cache


## How To Run Locally
- Prerequisites: `Ruby 3.4+`, `Node.js 18+` (tested with Node 20), `PostgreSQL 14+`, `bundler`, `npm`.
- Backend (Rails API):
  ```bash
  cd ruby_backend/tft_team_builder
  bundle install
  bundle exec rails db:create db:migrate db:seed
  bundle exec rails server # http://localhost:3000
  ```
- Frontend (Vue SPA):
  ```bash
  cd frontend/tft-builder
  npm install
  npm run dev # http://localhost:5173
  ```
- Open `http://localhost:5173`. The SPA calls the API at `http://localhost:3000/api`.
- Optional env:
  - Backend: `FRONTEND_ORIGINS=http://localhost:5173` (CORS).
  - Frontend: create `frontend/tft-builder/.env` with `VITE_API_BASE_URL=http://localhost:3000/api`.

### Email verification & password reset setup

The backend now sends real verification and password reset emails. Configure the following environment variables (e.g., in `.env`, `heroku config:set`, or your deployment platform):

| Variable | Purpose |
| --- | --- |
| `FRONTEND_BASE_URL` | Absolute URL to the SPA (defaults to `http://localhost:5173`). Used to build the verify/reset links. |
| `MAILER_FROM_EMAIL` | The sender address shown in emails (defaults to `noreply@tftsmarthub.com`). |
| `MAILER_HOST` / `MAILER_PORT` / `MAILER_PROTOCOL` | Host values for URLs generated by Rails Mailers (defaults to `localhost:3000` in development). |
| `SMTP_ADDRESS` | SMTP server hostname. When present (even in development) Rails switches from `letter_opener` to SMTP delivery. |
| `SMTP_PORT` | SMTP port (defaults to `587`). |
| `SMTP_USERNAME` / `SMTP_PASSWORD` | Credentials for the SMTP server (if required). |
| `SMTP_AUTH` | Authentication strategy (`plain`, `login`, etc.). Defaults to `plain`. |
| `SMTP_ENABLE_STARTTLS_AUTO` | `"true"` / `"false"` toggle for STARTTLS (defaults to `true`). |

After setting these variables and restarting the Rails server, new registrations will receive a 6-character verification code via email, and users can request password reset links that expire after 2 hours.

## How To Deploy To Heroku (Rails API)
Deploy the Rails API; host the SPA separately (e.g., Netlify/Vercel) and point it to the Heroku API.

1) Create the app and Postgres
```bash
heroku login
heroku create tft-smartcomp-api --stack=heroku-22
heroku addons:create heroku-postgresql:mini -a tft-smartcomp-api
```

2) Configure environment
```bash
# Required if using Rails credentials
heroku config:set RAILS_MASTER_KEY=... -a tft-smartcomp-api

# CORS: set your production frontend origin(s)
heroku config:set FRONTEND_ORIGINS=https://frontend.tftcompapi.com -a tft-smartcomp-api

# Optional
heroku config:set RAILS_LOG_TO_STDOUT=enabled RACK_ENV=production RAILS_ENV=production -a tft-smartcomp-api
```

3) Push from repo (using git subtree)
```bash
# From the repo root
git subtree push --prefix ruby_backend/tft_team_builder heroku main
```

4) Run migrations (and optional seed)
```bash
heroku run rails db:migrate -a tft-smartcomp-api
heroku run rails db:seed -a tft-smartcomp-api # optional
```

5) Point the SPA to Heroku
- Set `VITE_API_BASE_URL=https://tft-smartcomp-api.herokuapp.com/api` in the frontendâ€™s environment and deploy your SPA.

---

## Authors
- Ruitao Zhou (backend)
- Youran Ma (frontend)

## Purpose & Problem Statement
- A Teamfight Tactics (TFT) roster and composition builder with recommendations.
- Ships curated comps, champion/trait data, and a recommender that suggests best-fit comps given selected champions.

## MVP Structure
- Backend (Rails 8 API): JSON endpoints for champions, team comps (CRUD), and recommendations; JWT auth; absolute asset URLs; concise serializers.
- Frontend (Vue 3 + Vite SPA): search and recommendation views, comp list/detail, comp editor, login/profile management.
- Database (PostgreSQL): users, champions, traits, team comps; stores win/play rates, notes and source.

## Changelog (Brief)
- Implemented team comp CRUD and recommendation endpoint.
- Unified serializer output (e.g., `winRate`, `playRate`, `cards`) and absolute image/sprite URLs.
- Added JWT auth and role-based permissions (user/admin).

## Database Schema (Core Fields)

### users
| Column          | Type     | Constraints/Notes                   |
|-----------------|----------|-------------------------------------|
| id              | integer  | primary key                         |
| email           | string   | not null, unique index              |
| password_digest | string   | not null                            |
| role            | string   | not null, default `user`, indexed   |
| display_name    | string   |                                     |
| bio             | text     |                                     |
| location        | string   |                                     |
| avatar_url      | string   |                                     |
| created_at      | datetime |                                     |
| updated_at      | datetime |                                     |

### champions
| Column      | Type    | Constraints/Notes                         |
|-------------|---------|-------------------------------------------|
| id          | integer | primary key                               |
| name        | string  |                                           |
| tier        | integer |                                           |
| traits      | string  | e.g. "Bruiser / Void" (slash-delimited)   |
| image_url   | string  | relative or absolute; served as absolute  |
| sprite_name | string  | sprite sheet name                         |
| sprite_x    | integer |                                           |
| sprite_y    | integer |                                           |
| sprite_w    | integer |                                           |
| sprite_h    | integer |                                           |
| created_at  | datetime|                                           |
| updated_at  | datetime|                                           |

### traits
| Column       | Type    | Constraints/Notes |
|--------------|---------|-------------------|
| id           | integer | primary key       |
| api_id       | string  |                   |
| name         | string  |                   |
| image_full   | string  |                   |
| image_sprite | string  |                   |
| image_x      | integer |                   |
| image_y      | integer |                   |
| image_w      | integer |                   |
| image_h      | integer |                   |
| created_at   | datetime|                   |
| updated_at   | datetime|                   |

### team_comps
| Column      | Type     | Constraints/Notes                                 |
|-------------|----------|---------------------------------------------------|
| id          | integer  | primary key                                       |
| name        | string   | not null                                          |
| description | text     |                                                   |
| champions   | string   | comma-separated champion names                    |
| win_rate    | decimal  | precision:5, scale:4 (0.0000â€“1.0000), indexed     |
| play_rate   | decimal  | precision:5, scale:4 (0.0000â€“1.0000), indexed     |
| notes       | text     |                                                   |
| source      | string   |                                                   |
| created_at  | datetime |                                                   |
| updated_at  | datetime |                                                   |

> Source of truth: `ruby_backend/tft_team_builder/db/schema.rb`.

## API Endpoints (Concise)
- Auth & Profile
  - POST `/api/auth/register` â€” body `user:{ email, password, password_confirmation, display_name?, bio?, location?, avatar_url? }` â€” returns `{ token, user }`.
  - POST `/api/auth/login` â€” body `user:{ email, password }` â€” returns `{ token, user }`.
  - GET `/api/auth/me` â€” returns `{ user }` (requires `Authorization: Bearer <token>`).
  - GET `/api/profile` â€” returns `{ user }` (requires auth).
  - PATCH `/api/profile` â€” body `user:{ display_name?, bio?, location?, avatar_url?, password?, password_confirmation? }` â€” returns `{ user }` (requires auth).
- Champions
  - GET `/api/champions` â€” returns `[ { id, name, tier, traits[], imageUrl, sprite{ sheet,x,y,w,h } } ]`.
  - GET `/api/champions/:id` â€” returns one champion; 404 if not found.
- Team Comps (admin can update/delete; any authenticated user can create)
  - GET `/api/team_comps?limit=50&include_cards=true` â€” returns list of comps with `championNames[]` and optional `cards[]`.
  - GET `/api/team_comps/:id` â€” returns one comp.
  - POST `/api/team_comps` â€” body `team_comp:{ name, description?, notes?, source?, win_rate?, play_rate?, champion_ids?[], champion_names?[], champions?[] }`.
    - Server merges/normalizes names into `champions` and accepts rates as `0â€“1` or percentages.
  - PATCH `/api/team_comps/:id` â€” same body; admin only.
  - DELETE `/api/team_comps/:id` â€” admin only.
  - POST `/api/team_comps/recommendations` â€” body may include `include_cards`/`include_card_ids`/`includeCards`/`includeCardIds` (array of champion IDs); returns `{ requestedChampionIds, requestedChampionNames, teams:[ TeamComp + meta ] }` where `meta:{ matchCount, matchRatio, matchedChampionNames[], missingChampionNames[] }`.

Note: Use `Authorization: Bearer <token>` for protected endpoints. Response fields follow the serializers in the codebase.

## Roadmap
- Bug fix: adjust sprite picture cut and improve UI view.
- Data ingestion: hook into live/external data for dynamic comps and rates.
- Recommendation: add exclusions, trait weighting, patch filters.
- Quality: E2E tests (Playwright/Cypress) and fuller backend coverage.
- Personalization: drafts/favorites/ratings; sharing and comments.
